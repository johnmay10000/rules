# .cursorrules - Python Data Processing Project

**Project**: Data Analytics Pipeline  
**Stack**: Python 3.11+, Polars, returns, pytest  
**Platform**: Google Cloud Run Functions  

---

## Global Rules
@${CURSOR_RULES_PATH}/cursor/CURSOR.md

## Language-Specific Rules
@${CURSOR_RULES_PATH}/cursor/python-fp-style-guide.md

## Platform-Specific Rules
@${CURSOR_RULES_PATH}/cursor/GCP_GUIDELINES.md

---

## Project Context

### Tech Stack
- **Language**: Python 3.11+
- **FP Library**: returns (Result types, IO, pipeline)
- **Data Processing**: Polars (mandatory - no pandas)
- **Package Manager**: uv (mandatory)
- **Type Checking**: mypy --strict
- **Linting**: ruff, black, isort
- **Testing**: pytest (100% coverage required)

### Cloud Platform
- **Platform**: Google Cloud Platform
- **Compute**: Cloud Run Functions (Python 3.11)
- **Storage**: Cloud Storage (GCS)
- **Triggers**: HTTP, Pub/Sub, Cloud Scheduler

### Project Structure
```
project_root/
├── src/
│   ├── types/              # ADTs and type definitions
│   │   ├── __init__.py
│   │   ├── result.py       # Custom Result extensions
│   │   └── data_types.py   # Domain types
│   ├── pure/               # Pure business logic (no IO)
│   │   ├── __init__.py
│   │   ├── compute.py      # Computations
│   │   └── transform.py    # Data transformations
│   ├── io/                 # IO operations (GCS, etc.)
│   │   ├── __init__.py
│   │   ├── load.py         # Load from GCS
│   │   └── save.py         # Save to GCS
│   ├── pipeline/           # Composed pipelines
│   │   ├── __init__.py
│   │   └── process.py      # Main pipeline
│   └── functions/          # Cloud Function entry points
│       ├── __init__.py
│       └── main.py         # HTTP/trigger handlers
├── tests/
│   ├── test_pure/          # Tests for pure functions
│   ├── test_io/            # Tests for IO (mocked)
│   └── test_pipeline/      # Integration tests
├── pyproject.toml          # uv configuration
├── requirements.txt        # Generated by uv
└── .cursorrules            # This file
```

---

## Mandatory Rules for This Project

### Code Style (from CURSOR.md)
- ✅ All files **< 250 lines** (mandatory)
- ✅ Type hints on **all functions**
- ✅ Public functions **return Result types**
- ✅ No exceptions except at IO boundaries
- ✅ Dataclasses with `frozen=True`
- ✅ Pattern matching for ADTs

### Testing (from CURSOR.md)
- ✅ **100% coverage** for pure functions
- ✅ **3+ tests per function** minimum
- ✅ All tests **must pass** before commit
- ✅ Use `sys.path.append()` for Cloud Functions imports

### Data Processing (Project-Specific)
- ✅ **Polars only** - no pandas
- ✅ Use `.pipe()` for chaining operations
- ✅ Lazy evaluation where possible
- ✅ Explicit schemas for all data frames

### Git Workflow (from CURSOR.md)
- ✅ **Commit every 30-60 min** (mandatory)
- ✅ Commit message follows template
- ✅ Update TODO list after each task

---

## Example: Cloud Function Structure

```python
# src/functions/main.py - Entry point (IO boundary)
from returns.result import Result, Success, Failure
from returns.io import IOResult, impure_safe
from ..pipeline.process import process_data
import functions_framework

@functions_framework.http
def main(request):
    """HTTP trigger - IO boundary."""
    result = process_data(request.get_json())
    
    match result:
        case Success(data):
            return {"status": "success", "data": data}, 200
        case Failure(error):
            return {"status": "error", "message": str(error)}, 500
```

```python
# src/pipeline/process.py - Pure pipeline
from returns.result import Result
from returns.pipeline import flow
from ..pure.compute import compute
from ..pure.transform import transform
from ..io.load import load_data
from ..io.save import save_data

def process_data(input_params: dict) -> Result[dict, str]:
    """Pure data processing pipeline."""
    return (
        load_data(input_params)          # IO → Result
        .bind(transform)                 # Pure → Result
        .bind(compute)                   # Pure → Result
        .bind(save_data)                 # IO → Result
    )
```

---

## Testing Pattern

```python
# tests/test_pure/test_compute.py
import sys
sys.path.append('src')  # Required for Cloud Functions

from src.pure.compute import compute
from returns.result import Success, Failure

def test_compute_valid_input():
    result = compute({"value": 10})
    assert isinstance(result, Success)
    assert result.unwrap()["processed"] == 20

def test_compute_invalid_input():
    result = compute({"value": -1})
    assert isinstance(result, Failure)
    assert "negative" in str(result.failure())
```

---

## Before Every Commit Checklist

- [ ] All tests passing (`uv run pytest`)
- [ ] Type checks passing (`uv run mypy src/`)
- [ ] Linters passing (`uv run ruff check src/`)
- [ ] Black formatting (`uv run black src/`)
- [ ] Import sorting (`uv run isort src/`)
- [ ] All files < 250 lines
- [ ] Commit message follows template
- [ ] TODO list updated (if applicable)

---

## Quick Commands

```bash
# Install dependencies
uv pip install -r requirements.txt

# Run tests with coverage
uv run pytest --cov=src --cov-report=term-missing

# Type check
uv run mypy src/ --strict

# Lint and format
uv run ruff check src/
uv run black src/
uv run isort src/

# Deploy to GCP
gcloud functions deploy my-function \
  --runtime python311 \
  --trigger-http \
  --entry-point main \
  --source .
```

---

**This .cursorrules file demonstrates**:
- Integration with global rules (CURSOR.md)
- Language-specific rules (Python FP guide)
- Platform-specific rules (GCP)
- Project-specific structure and requirements
- Practical examples and patterns
- Testing strategy
- Before-commit checklist

**See Also**:
- [CURSOR.md](../CURSOR.md) - Mandatory universal rules
- [python-fp-style-guide.md](../python-fp-style-guide.md) - Python FP patterns
- [SETUP_GUIDE.md](../SETUP_GUIDE.md) - Initial setup instructions

